# OUH Document Build task (Direct CI) - OUH-Hugo: Updated 16-07-2024. v3.2.0
pages:
  image: $CI_REGISTRY/www/pages-ouh-hugo:472b2f8c
  stage: deploy
  tags: ["pages"]

  before_script:
    # Rather than do an external npm install, copy the pre-loaded files into the docs folder
    - mv /pre-docs/node_modules docs/
    - cd docs/

  script:
    - export HUGO_CACHEDIR="/pre-docs/cache/hugo"
    - echo "Pre-build Cache"
    - du -s $HUGO_CACHEDIR
    - hugo mod graph
    - hugo --minify --gc --templateMetrics --logLevel debug
    - echo "Post-build Cache"
    - du -s $HUGO_CACHEDIR

  after_script:
    # - pwd
    # - ls -la
    - /usr/local/bin/pagefind --site "public"

  artifacts:
    paths:
    - public
    expire_in: 20 mins

  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'  # EDIT ME for your project's published branch, typically "main"
